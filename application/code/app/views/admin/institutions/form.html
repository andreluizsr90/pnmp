{% extends "master/layout.html" %}

{% block maincontent %}

<div class="font-weight-medium shadow-none position-relative overflow-hidden mb-7">
    <div class="card-body px-0">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="font-weight-medium  mb-0">Instituições: {{ record._id ? 'Atualizar' : 'Novo' }}</h4>
        </div>
        <div>
          <div class="d-sm-flex d-none gap-3 no-block justify-content-end align-items-center">
            <div class="d-flex gap-2">
                <a href="{{ route }}" class="btn btn-danger">Cancelar</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="card w-100 position-relative overflow-hidden">
    <div class="card-body p-4">
                         
      <div class="row">
        <div class="col-md-8 mx-auto">
          <form method="POST" class="mt-3 form-horizontal">
            <div class="form-group row my-2">
                <label for="code" class="col-sm-4 col-form-label">Código</label>
                <div class="col-sm-8">
                    <input {{ record._id ? 'disabled' : 'required' }} name="code" type="text" class="form-control" id="code" value="{{ record.code }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="name" class="col-sm-4 col-form-label">Nome</label>
                <div class="col-sm-8">
                    <input required name="name" type="text" class="form-control" id="name" value="{{ record.name }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="phone" class="col-sm-4 col-form-label">Telefone</label>
                <div class="col-sm-8">
                    <input required name="phone" type="text" class="form-control" id="phone" value="{{ record.phone }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="postal_code" class="col-sm-4 col-form-label">Código Postal</label>
                <div class="col-sm-8">
                    <input required name="postal_code" type="text" class="form-control" id="postal_code" value="{{ record.postal_code }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="address_1" class="col-sm-4 col-form-label">Endereço</label>
                <div class="col-sm-8">
                    <input required name="address_1" type="text" class="form-control" id="address_1" value="{{ record.address_1 }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="address_2" class="col-sm-4 col-form-label">Endereço (Complemento)</label>
                <div class="col-sm-8">
                    <input name="address_2" type="text" class="form-control" id="address_2" value="{{ record.address_2 }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="city" class="col-sm-4 col-form-label">Cidade</label>
                <div class="col-sm-8">
                    <input required name="city" type="text" class="form-control" id="city" value="{{ record.city }}" />
                </div>
            </div>
            <div class="form-group row my-2">
                <label for="city" class="col-sm-4 col-form-label">Unidade Administrativa:</label>
                <div class="col-sm-8" id="administrative-unit">
                </div>
            </div>
            <hr />
            <div class="row my-3">
              <label for="types" class="col-sm-4 col-form-label">Tipo de instituição</label>
              <div class="col-sm-8">
                {% for institution_type in institution_types %}
                <div class="form-check">
                  <input name="types[]" class="form-check-input types-field" type="checkbox" value="{{ institution_type }}" onchange="checkMedicineIsMarked(this)" id="check-{{ institution_type }}" {{ institution_type in record.types ? 'checked' }}>
                  <label class="form-check-label" for="check-{{ institution_type }}">
                    {{ lang.institution_types[institution_type] ?? institution_type }}
                  </label>
                </div>
                {% endfor %}
              </div>
            </div>
            <div class="form-group row my-2" id="dynamic-institution-supplier">
                <label for="city" class="col-sm-4 col-form-label">Instituição de fornecimento:</label>
                <div class="col-sm-8" id="institution-supplier">
                </div>
            </div>
            <div class="row my-3">
                <div class="col-12 text-center">
                  <a href="{{ route }}" class="btn btn-danger">Cancelar</a>
                  <button type="submit" class="btn btn-dark">Salvar</button>
                </div>
            </div>
          </form>
        </div>
      </div>

    </div>
  </div>

  {% endblock %}

  {% block javascript %}
  <script src="{{ url_assets }}/js/pnmp/PnmpSelectFieldMultilevel.class.js?id=5" type="text/javascript"></script> <!-- jquery -->
  <script src="{{ url_assets }}/js/pnmp/PnmpSelectFieldApi.class.js" type="text/javascript"></script> <!-- jquery -->
  <script>   
    var adminunit;

    var checkMedicineIsMarked = (obj) => {
      if($(obj).val() != "MEDICINE_STORE") {
        return;
      }
      
      let selected = false;
      $(".types-field").each((index, element) => {
        if($(element).prop('checked') == true && $(element).val() == "MEDICINE_STORE"){
          selected = true;
        }
      });
      
      if(selected) {
          $("#dynamic-institution-supplier").removeClass("d-none");

          PnmpSelectFieldApi.init(
            "{{ url_site }}/api/institutions/by-type", // URL API
            "institution-supplier", // ID of the place to add field
            "institution_supplier", // Field Name
            {"type": "MEDICINE_STORE", "ignore" : "{{ record._id }}"},
            false, // Is Required
            '{{ record.institution_supplier ? record.institution_supplier : 'false' }}'
          );
      } else {
        $("#institution-supplier").html("");
        $("#dynamic-institution-supplier").addClass("d-none");
      }
    };
    
    (function(){
    
      adminunit = new PnmpSelectFieldMultilevel(
      "{{ url_site }}/api/administrative-units/by-parent-id", // URL API Parent
      "{{ url_site }}/api/administrative-units/parents-by-id", // URL API Unique
        "adminunit", // Local variable name
        "administrative-unit", // ID of the place to add field
        "administrative_unit" // Field Name
      );
      adminunit.init('{{record.administrative_unit}}');

      {% if "MEDICINE_STORE" in record.types  %}
      
        PnmpSelectFieldApi.init(
          "{{ url_site }}/api/institutions/by-type", // URL API
          "institution-supplier", // ID of the place to add field
          "institution_supplier", // Field Name
          {"type": "MEDICINE_STORE", "ignore" : "{{ record._id }}"},
          false, // Is Required
          '{{ record.institution_supplier ? record.institution_supplier : 'false' }}'
        );
        $("#dynamic-institution-supplier").removeClass("d-none");
      {% else %}
        $("#dynamic-institution-supplier").addClass("d-none");
      {% endif %}
    })();

  </script>
  {% endblock %}